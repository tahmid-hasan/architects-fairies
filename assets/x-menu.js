export default class XMenu extends HTMLElement{constructor(){super()}connectedCallback(){this.current_width=window.innerWidth,this.state="closed",this.parent_links=this.querySelectorAll(".x-menu--level-1--link > a"),this.sub_menu_links=this.querySelectorAll('.x-menu--level-1--link:not([data-x-menu--depth="1"]) > a'),this.overlap_parent=parseInt(this.getAttribute("data-x-menu--overlap-parent")),this.header_root=document.querySelector(".header--root"),this.sub_menu_items=[],this.parents_with_sub_menu=[],this.sub_menu_links.forEach(e=>{var t=e.parentNode;this.parents_with_sub_menu.push(t);const n=e.parentNode.querySelectorAll("ul a");n.forEach(e=>this.sub_menu_items.push(e))}),this.load()}disconnectedCallback(){window.off("resize.XMenu"),this.parent_links.off("focus.XMenu"),this.sub_menu_links.off("touchstart.XMenu focus.XMenu"),this.parents_with_sub_menu.off("mouseleave.XMenu"),this.parents_with_sub_menu.forEach(e=>{e.querySelectorAll(":scope > a").off("mouseenter.XMenu")})}load(){this.arrangeMegaNav(),this.listeners(),this.checkOverlap(),this.resizeListeners(),this.transitionListeners()}listeners(){this.parents_with_sub_menu.forEach(e=>{e.querySelectorAll(":scope > a").on("mouseenter.XMenu",e=>this.slideDown(e.target))}),this.parents_with_sub_menu.on("mouseleave.XMenu",()=>this.slideUp()),this.parent_links.on("focus.XMenu",()=>this.slideUp),this.sub_menu_links.on("focus.XMenu",e=>this.slideDown(e.target)),this.sub_menu_links.on("touchstart.XMenu",e=>{e.preventDefault(),(menu_open="true"===e.target.parentNode.getAttribute("data-x-menu--open"))?this.slideUp():this.slideDown(e.target)})}checkOverlap(){if(theme.utils.isTouchDevice()&&"large"!==theme.mqs.current_window)return this.setAttribute("data-x-menu--overlap",!0),this.header_root.setAttribute("data-x-menu--overlap",!0),window.trigger("theme:XMenu:loaded"),!1;this.setAttribute("data-x-menu--overlap",!1),this.header_root.setAttribute("data-x-menu--overlap",!1);let e=this;1===this.overlap_parent?e=e.parentNode:2===this.overlap_parent&&(e=e.parentNode.parentNode);var t=e.parentNode,n=e.index();let s=!1,i=(1<n&&(s=t.children[n-1]),!1);if(n+1<t.children.length&&(i=t.children[n+1]),s){const r=s.querySelector(":scope > :last-child");t=r.offset().left+r.offsetWidth;e.offset().left-1<=t&&(this.setAttribute("data-x-menu--overlap",!0),this.header_root.setAttribute("data-x-menu--overlap",!0))}if(i){const o=e.querySelector(":scope > :last-child");n=o.offset().left+o.offsetWidth;i.offset().left-1<=n&&(this.setAttribute("data-x-menu--overlap",!0),this.header_root.setAttribute("data-x-menu--overlap",!0))}window.trigger("theme:XMenu:loaded")}resizeListeners(){window.on("resize.XMenu",theme.utils.debounce(100,()=>{this.current_width!==window.innerWidth&&(this.checkOverlap(),this.current_width=window.innerWidth)}))}arrangeMegaNav(){if(0===this.parents_with_sub_menu.length)return!1;const e=this.querySelectorAll('[data-x-menu--depth="3"] .x-menu--level-2--container');e.length&&e.forEach(e=>{const t=e.querySelectorAll('[data-x-menu--single-parent="true"]');if(t.length){const n=theme.utils.parseHtml('<div class="x-menu--single-parents"></div>');e.prepend(n);e=document.createElement("ul");n.appendChild(e),t.forEach(e=>{n.querySelector("ul").appendChild(e)})}})}slideDown(e,t=!1){clearTimeout(this.timer);const n=e.parentNode;if("true"===n.getAttribute("data-x-menu--open")||"closing"===this.state)return!1;if(this.slideUp(!1),t&&"complete"!==t)this.timer=setTimeout(()=>this.slideDown(e,"complete"),t);else{const s=e.closest(".x-menu--level-1--link"),i=(s.querySelector(".icon--chevron-up").style.display="inline",s.querySelector(".icon--chevron-down").style.display="none",n.setAttribute("data-x-menu--open",!0),e.setAttribute("aria-expanded",!0),s.querySelector(".x-menu--level-2--container"));i&&(i.setAttribute("data-transition","forwards"),i.style.height="auto"),this.state="open"}}slideUp(e=300){let t=!1,n=!1;for(let e=0;e<this.parents_with_sub_menu.length;e++){const s=this.parents_with_sub_menu[e];if("true"===s.getAttribute("data-x-menu--open")){n=s,t=n.querySelector(":scope > a");break}}if(n)if(e)this.timer=setTimeout(()=>this.slideUp(!1),e);else{const i=t.closest(".x-menu--level-1--link"),r=(i.querySelector(".icon--chevron-up").style.display="none",i.querySelector(".icon--chevron-down").style.display="inline",i.querySelector(".x-menu--level-2--container"));r&&r.setAttribute("data-transition","backwards"),t&&(t.setAttribute("aria-expanded",!1),n.setAttribute("data-x-menu--open",!1))}}transitionListeners(){this.sub_menu_links.forEach(e=>{const t=e.parentNode;if(t){const n=t.querySelectorAll(".x-menu--level-2--container");n.on("transition:at_start",e=>e.target.style.height="0")}})}}